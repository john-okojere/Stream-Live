{% extends "base.html" %}
{% load static %}

{% block title %}Upload Past Stream{% endblock %}

{% block head %}
<style>
  /* Layout + cards */
  .upload-header p{ color:var(--muted); margin:0 }
  .form-pane, .files-pane{
    border:1px solid var(--ring);
    border-radius:1rem;
    background:var(--glass);
    backdrop-filter:saturate(160%) blur(8px);
  }
  .form-pane .form-group{ margin-bottom:14px }
  .form-pane label{ font-weight:700; margin-bottom:.35rem }
  .help-text{ color:var(--muted); font-size:.9rem }

  /* Inputs */
  .form-pane input[type="text"],
  .form-pane input[type="date"],
  .form-pane textarea{
    width:100%; padding:.6rem .8rem; border:1px solid var(--ring);
    border-radius:.6rem; background:#0b1222; color:#e6edf3;
  }
  .form-pane textarea{ min-height:120px; resize:vertical }

  /* Errors */
  .errorlist{ list-style:none; padding-left:0; margin:.35rem 0 0 0 }
  .errorlist li{
    background:#5a161b; color:#ffd2d6; border:1px solid #732027;
    padding:.4rem .6rem; border-radius:.5rem; font-size:.9rem;
  }

  /* Dropzones */
  .dz{
    position:relative; border:1px dashed rgba(255,255,255,.25);
    border-radius:.9rem; padding:14px;
    background:rgba(255,255,255,.03);
    transition:border-color .2s ease, background .2s ease;
  }
  .dz:hover{ border-color:rgba(255,255,255,.45) }
  .dz.is-dragover{ background:rgba(255,255,255,.06); border-color:#fff }
  .dz-title{ display:flex; align-items:center; gap:.5rem; font-weight:800 }
  .dz-sub{ color:var(--muted); font-size:.9rem; margin:0 }
  .dz-preview{ margin-top:.75rem; display:flex; gap:.75rem; align-items:center }
  .dz-cover{
    width:64px; height:64px; border-radius:.6rem; object-fit:cover; background:#202a3f;
  }
  .dz-audio audio{ width:100%; height:36px }

  /* Progress UI */
  #uploadWrap{ display:none; }
  #uploadWrap.is-visible{ display:block; }
  .progress { height:10px; background: rgba(255,255,255,.08); }
  .progress-bar { font-size:.75rem; }
</style>
{% endblock %}

{% block content %}
<main class="container py-5">
  <div class="upload-header d-flex flex-wrap justify-content-between align-items-end gap-2 mb-4">
    <div>
      <h1 class="h3 m-0">Upload Past Stream</h1>
      <p>Add title and details on the left, then drop your cover and audio on the right.</p>
    </div>
    <div class="page-actions d-flex gap-2">
      <a class="btn btn-soft btn-sm" href="{% url 'stream:past_list' %}"><i class="bi bi-arrow-left"></i> Back</a>
    </div>
  </div>

  {% if form.non_field_errors %}
    <div class="alert alert-danger">{{ form.non_field_errors }}</div>
  {% endif %}

  <form id="uploadForm" method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}

    <div class="row g-3">
      <!-- Left: details -->
      <div class="col-lg-7">
        <div class="form-pane p-3 p-md-4">
          <div class="form-group">
            {{ form.title.label_tag }} {{ form.title }}
            {{ form.title.errors }}
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <div class="form-group">
                {{ form.speaker.label_tag }} {{ form.speaker }}
                {{ form.speaker.errors }}
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                {{ form.date.label_tag }} {{ form.date }}
                {{ form.date.errors }}
              </div>
            </div>
          </div>

          <div class="form-group">
            {{ form.description.label_tag }} {{ form.description }}
            {{ form.description.errors }}
            <div class="help-text">Optional: brief summary, scripture references, etc.</div>
          </div>

          <div class="form-group">
            {{ form.tags.label_tag }} {{ form.tags }}
            {{ form.tags.errors }}
            <div class="help-text">Comma-separated (e.g. <em>faith, worship, prayer</em>)</div>
          </div>
        </div>
      </div>

      <!-- Right: files -->
      <div class="col-lg-5">
        <div class="files-pane p-3 p-md-4">
          <!-- Keep Django file inputs (hidden) so validation & names work -->
          <div class="d-none">
            {{ form.cover }} {{ form.cover.errors }}
            {{ form.audio }} {{ form.audio.errors }}
          </div>

          <!-- Cover dropzone -->
          <section class="dz" id="dzCover">
            <div class="dz-title"><i class="bi bi-image"></i> Cover image</div>
            <p class="dz-sub">PNG/JPG. Recommended square (e.g. 1000×1000).</p>
            <div class="dz-preview" id="coverPreview">
              <img class="dz-cover" id="coverThumb" src="{% static 'assets/gatherings-flyer.png' %}" alt="">
              <div class="small" style="color:var(--muted)">
                <div id="coverName">No file selected</div>
                <div id="coverSize"></div>
              </div>
            </div>
            <div class="mt-2">
              <button type="button" class="btn btn-soft btn-sm" id="pickCover"><i class="bi bi-upload"></i> Choose image</button>
            </div>
          </section>

          <div style="height:12px"></div>

          <!-- Audio dropzone -->
          <section class="dz" id="dzAudio">
            <div class="dz-title"><i class="bi bi-music-note-beamed"></i> Audio file</div>
            <p class="dz-sub">MP3/M4A/WAV. We’ll detect duration automatically.</p>
            <div class="dz-preview dz-audio" id="audioPreview">
              <div class="flex-grow-1">
                <div class="small" style="color:var(--muted)">
                  <div id="audioName" style="white-space:wrap;width:350px;overflow:hidden;">No file selected</div>
                  <div id="audioMeta"></div>
                </div>
                <audio id="audioPlayer" controls style="margin-top:.35rem;"></audio>
              </div>
            </div>
            <div class="mt-2">
              <button type="button" class="btn btn-soft btn-sm" id="pickAudio"><i class="bi bi-upload"></i> Choose audio</button>
            </div>
          </section>

          <!-- Progress UI -->
          <div id="uploadWrap" class="mt-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <strong id="uploadLabel">Uploading…</strong>
              <span id="uploadPct" class="text-muted">0%</span>
            </div>

            <div class="progress">
              <div id="uploadBar" class="progress-bar" role="progressbar" style="width:0%"></div>
            </div>

            <div class="d-flex justify-content-between small mt-2">
              <span id="uploadBytes">0 / 0</span>
              <span id="uploadSpeed">—</span>
              <span id="uploadEta">ETA —</span>
            </div>

            <button id="cancelUpload" type="button" class="btn btn-link btn-sm mt-1 text-danger">
              <i class="bi bi-x-circle"></i> Cancel
            </button>
          </div>

          <div class="mt-3 d-grid">
            <button id="submitBtn" class="btn btn-brand"><i class="bi bi-cloud-arrow-up"></i> Save & Upload</button>
          </div>
        </div>
      </div>
    </div>
  </form>
</main>
{% endblock %}

{% block scripts %}
<script>
(() => {
  // ---------- helpers ----------
  const $ = s => document.querySelector(s);
  const bytes = n => {
    if(n==null) return "";
    const u=['B','KB','MB','GB','TB']; let i=0; while(n>=1024&&i<u.length-1){n/=1024;i++}
    return n.toFixed(i?1:0)+' '+u[i];
  };
  const fmt = sec => { sec=Math.max(0,Math.round(sec||0)); const m=Math.floor(sec/60), s=sec%60, h=Math.floor(m/60);
    return h?`${h}:${String(m%60).padStart(2,'0')}:${String(s).padStart(2,'0')}`:`${m}:${String(s).padStart(2,'0')}`; };
  const csrf = () => (document.querySelector('input[name="csrfmiddlewaretoken"]')||{}).value || '';
  const setDrag = el => {
    if(!el) return;
    el.addEventListener('dragover', e=>{e.preventDefault(); el.classList.add('is-dragover')});
    ['dragleave','dragend','drop'].forEach(evt=> el.addEventListener(evt, ()=> el.classList.remove('is-dragover')));
  };

  // ---------- elements ----------
  const form = $('#uploadForm');
  const submitBtn = $('#submitBtn');

  // cover
  const dzCover = $('#dzCover');
  const coverInput = $('#id_cover');
  const pickCover = $('#pickCover');
  const coverThumb = $('#coverThumb');
  const coverName = $('#coverName');
  const coverSize = $('#coverSize');

  // audio
  const dzAudio = $('#dzAudio');
  const audioInput = $('#id_audio');
  const pickAudio = $('#pickAudio');
  const audioName = $('#audioName');
  const audioMeta = $('#audioMeta');
  const audioPlayer = $('#audioPlayer');

  // progress UI
  const wrap = $('#uploadWrap');
  const bar = $('#uploadBar');
  const label = $('#uploadLabel');
  const pct = $('#uploadPct');
  const bytesEl = $('#uploadBytes');
  const speedEl = $('#uploadSpeed');
  const etaEl = $('#uploadEta');
  const cancelBtn = $('#cancelUpload');

  // defaults
  coverInput?.setAttribute('accept','image/*');
  audioInput?.setAttribute('accept','audio/*,audio/mpeg,audio/mp4');

  // start hidden (CSS controls visibility)
  wrap.classList.remove('is-visible');

  // dnd
  setDrag(dzCover); setDrag(dzAudio);

  // previews
  function handleCover(file){
    if(!file) return;
    coverName.textContent = file.name;
    coverSize.textContent = bytes(file.size);
    if(/^image\//.test(file.type)){
      const r = new FileReader();
      r.onload = e => coverThumb.src = e.target.result;
      r.readAsDataURL(file);
    }
  }
  function handleAudio(file){
    if(!file) return;
    audioName.textContent = `${file.name} (${bytes(file.size)})`;
    audioPlayer.src = URL.createObjectURL(file);
    audioPlayer.onloadedmetadata = () => audioMeta.textContent = 'Duration: ' + fmt(audioPlayer.duration||0);
  }

  pickCover?.addEventListener('click', ()=> coverInput?.click());
  pickAudio?.addEventListener('click', ()=> audioInput?.click());
  coverInput?.addEventListener('change', ()=> handleCover(coverInput.files[0]));
  audioInput?.addEventListener('change', ()=> handleAudio(audioInput.files[0]));

  dzCover?.addEventListener('drop', e=>{
    e.preventDefault();
    const f = e.dataTransfer.files?.[0]; if(!f) return;
    const dt = new DataTransfer(); dt.items.add(f); coverInput.files = dt.files; handleCover(f);
  });
  dzAudio?.addEventListener('drop', e=>{
    e.preventDefault();
    const f = e.dataTransfer.files?.[0]; if(!f) return;
    const dt = new DataTransfer(); dt.items.add(f); audioInput.files = dt.files; handleAudio(f);
  });

  // ---------- upload state ----------
  let xhr=null, phase='idle', lastLoaded=0, lastStamp=0, stallTimer=null;

  function showWrap(){ wrap.classList.add('is-visible'); }
  function hideWrap(){ wrap.classList.remove('is-visible'); }
  function disableInputs(disabled){
    [submitBtn,pickCover,pickAudio,coverInput,audioInput].forEach(el=> el && (el.disabled = disabled));
  }
  function resetBar(){
    bar.style.width='0%';
    bar.className='progress-bar';
    pct.textContent='0%'; bytesEl.textContent='0 / 0';
    speedEl.textContent='—'; etaEl.textContent='ETA —';
  }
  function setPhase(next){
    phase = next;
    if(next==='upload'){
      showWrap(); resetBar(); disableInputs(true);
      label.textContent='Uploading…';
      bar.classList.remove('bg-success','bg-danger','progress-bar-animated','progress-bar-striped');
      cancelBtn.disabled=false;
    } else if(next==='processing'){
      label.textContent='Processing…';
      pct.textContent='100%'; bar.style.width='100%';
      bar.classList.add('progress-bar-striped','progress-bar-animated');
      speedEl.textContent='—'; etaEl.textContent='—'; cancelBtn.disabled=true;
    } else if(next==='done'){
      label.textContent='Done';
      bar.classList.remove('progress-bar-animated','progress-bar-striped');
      bar.classList.add('bg-success');
    } else if(next==='error'){
      label.textContent='Error';
      bar.classList.remove('progress-bar-animated','progress-bar-striped');
      bar.classList.add('bg-danger');
      disableInputs(false); cancelBtn.disabled=false;
    }
  }
  function toProcessingGuard(){ if(phase==='upload') setPhase('processing'); }
  function restartStallWatch(total, loaded){
    clearTimeout(stallTimer);
    const pc = total ? (loaded/total)*100 : 0;
    if(pc>=99) stallTimer = setTimeout(()=> toProcessingGuard(), 1000);
  }

  cancelBtn?.addEventListener('click', ()=>{
    if(xhr) xhr.abort();
    disableInputs(false); hideWrap(); resetBar();
  });

  form?.addEventListener('submit', (e)=>{
    e.preventDefault();

    const action = form.getAttribute('action') || location.href;
    const data = new FormData(form);

    xhr = new XMLHttpRequest();
    xhr.open('POST', action, true);
    xhr.setRequestHeader('X-Requested-With','XMLHttpRequest');
    const token = csrf(); if(token) xhr.setRequestHeader('X-CSRFToken', token);

    // show on loadstart to avoid race
    xhr.upload.addEventListener('loadstart', () => setPhase('upload'));

    // progress
    xhr.upload.addEventListener('progress', ev=>{
      if(!ev.lengthComputable){ label.textContent='Uploading…'; return; }
      const now = performance.now();
      const p = Math.min(100, Math.round((ev.loaded/ev.total)*100));
      bar.style.width = p+'%'; pct.textContent = p+'%';
      bytesEl.textContent = `${bytes(ev.loaded)} / ${bytes(ev.total)}`;

      if(lastStamp){
        const dt = (now-lastStamp)/1000;
        const dl = ev.loaded-lastLoaded;
        const sp = dl/(dt||1);
        speedEl.textContent = (sp/1048576).toFixed(2)+' MB/s';
        const remain = (ev.total-ev.loaded)/(sp||1);
        etaEl.textContent = 'ETA '+fmt(remain);
      }
      lastLoaded=ev.loaded; lastStamp=now;

      if(p>=100) toProcessingGuard();
      restartStallWatch(ev.total, ev.loaded);
    });

    // bytes finished sending
    xhr.upload.addEventListener('loadend', toProcessingGuard);

    // when server starts responding
    xhr.addEventListener('readystatechange', ()=> { if(xhr.readyState>=2) toProcessingGuard(); });

    // final result
    xhr.addEventListener('load', ()=>{
      clearTimeout(stallTimer);
      if(xhr.status>=200 && xhr.status<400){
        setPhase('done');
        // If your view returns a redirect, responseURL will be the final URL:
        location.href = xhr.responseURL || action;
      } else {
        setPhase('error');
        alert('Upload failed ('+xhr.status+'). Please try again.');
      }
    });

    xhr.addEventListener('error', ()=>{ clearTimeout(stallTimer); setPhase('error'); alert('Network error during upload.'); });
    xhr.addEventListener('abort', ()=> clearTimeout(stallTimer));

    xhr.send(data);
  });
})();
</script>
{% endblock %}
