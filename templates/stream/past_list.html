{% extends "base.html" %}
{% load static %}

{% block title %}Streams | Layers of Truth{% endblock %}
{% block meta %}
<!-- SEO -->
<meta name="description" content="Stream live messages and explore past sermons from Layers of Truth. Play, queue, and share inspiring teachings anytime." />
<meta name="robots" content="index,follow" />
<link rel="canonical" href="https://stream.layersoftruth.org/" />
<meta property="og:site_name" content="Layers of Truth" />
<meta property="og:title" content="Layers of Truth – Live & Past Sermons" />
<meta property="og:description" content="Stream live messages and explore past sermons from Layers of Truth. Play, queue, and share inspiring teachings anytime." />
<meta property="og:url" content="https://stream.layersoftruth.org/" />
<meta property="og:type" content="website" />
<meta property="og:image" content="{% static 'assets/worship.png' %}" />
<meta property="og:image:alt" content="Layers of Truth" />
<meta property="og:locale" content="en_NG" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Layers of Truth – Live & Past Sermons" />
<meta name="twitter:description" content="Stream live messages and explore past sermons from Layers of Truth. Play, queue, and share inspiring teachings anytime." />
<meta name="twitter:image" content="{% static 'assets/worship.png' %}" />
{% endblock %}

{% block head %}
<style>
  .library-hero{
    background:
      radial-gradient(120% 120% at -10% -20%, rgba(123,140,255,.2), transparent 50%),
      radial-gradient(110% 110% at 120% -10%, rgba(210,72,255,.16), transparent 52%),
      linear-gradient(135deg, rgba(15,22,40,.94), rgba(10,16,28,.9));
  }
  .library-hero::after{
    content:""; position:absolute; inset:0;
    background:radial-gradient(280px 280px at 80% 35%, rgba(255,255,255,.05), transparent 60%);
    pointer-events:none;
  }

  .filters-card{
    border:1px solid rgba(255,255,255,.08);
    border-radius:16px;
    background: rgba(255,255,255,.04);
  }

  .btn-brand{
    border:0; border-radius:12px; color:#fff;
    background:linear-gradient(90deg, var(--accent), var(--accent-2));
    font-weight:800; letter-spacing:.2px;
    box-shadow:0 10px 26px rgba(123,140,255,.28);
  }
  .btn-soft{
    border-radius:12px;
    background: rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.16);
    color:#e6edf3;
  }

  .lot-card{
    background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.08);
    border-radius:16px; overflow:hidden;
    transition: transform .22s ease, box-shadow .22s ease, border-color .22s ease;
    box-shadow: 0 16px 34px rgba(0,0,0,.32);
  }
  .lot-card:hover{ transform: translateY(-4px); border-color: rgba(123,140,255,.36); box-shadow: 0 20px 40px rgba(0,0,0,.38); }
  .lot-thumb{ position:relative; aspect-ratio:16/9; background: linear-gradient(135deg,#121b32,#0c1222); }
  .lot-thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
  .lot-thumb::after{
    content:""; position:absolute; inset:0;
    background: linear-gradient(180deg, rgba(0,0,0,0) 30%, rgba(0,0,0,.55));
    pointer-events:none;
  }
  .lot-actions{ position:absolute; top:.6rem; right:.6rem; display:flex; gap:.4rem; z-index:2; }
  .lot-overlay{
    position:absolute; inset:0; z-index:2;
    display:flex; align-items:flex-end; justify-content:space-between;
    padding:.7rem;
  }
  .lot-chip{
    display:inline-flex; align-items:center; gap:.35rem;
    padding:.3rem .65rem; border-radius:999px;
    background: rgba(0,0,0,.55); color:#e6edf3;
    border:1px solid rgba(255,255,255,.18);
    font-weight:700; font-size:.9rem;
  }
  .tag-pill{
    display:inline-flex; align-items:center; gap:.3rem;
    padding:.25rem .6rem; border-radius:999px;
    background: rgba(255,255,255,.06);
    border: 1px dashed rgba(255,255,255,.18);
    color:#dfe3ff; font-size:.82rem;
  }
  .meta-line{ color: var(--muted); font-size:.93rem; }

  .quick-list{ list-style:none; padding:0; margin:0; display:grid; gap:.75rem; }
  .quick-item{ display:flex; align-items:center; gap:.65rem; }
  .quick-item img{ width:50px; height:50px; object-fit:cover; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:#0b1222; }

  .active-filters{ display:flex; flex-wrap:wrap; gap:.5rem; }

  /* Detail modal polish */
  #sermonModal .modal-content{
    background: rgba(20,28,46,.84);
    border:1px solid rgba(255,255,255,.12);
    border-radius:18px;
    backdrop-filter: blur(12px) saturate(160%);
  }
  #sermonModal #md-cover{ width:160px; height:160px; object-fit:cover; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:#0d1222; }
  #sermonModal .badge{ background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.16); }

  .queued-burst{
    position:absolute; inset:auto 12px 12px auto;
    background: rgba(123,140,255,.2);
    color:#dfe3ff; border:1px solid rgba(123,140,255,.45);
    padding:.3rem .6rem; border-radius:10px; font-weight:700; font-size:.85rem;
    animation:fadeOut 1.1s ease forwards;
  }
  @keyframes fadeOut{ 0%{opacity:0; transform:translateY(6px)} 25%{opacity:1; transform:none} 100%{opacity:0; transform:translateY(-6px)} }

  @media (max-width: 575.98px){
    .lot-card{ border-radius:12px; }
    .lot-thumb{ aspect-ratio: 4/3; }
    .lot-actions .btn{ padding:.35rem .5rem; }
    .lot-overlay .btn{ padding:.25rem .5rem; font-size:.82rem; }
  }
</style>
{% endblock %}

{% block content %}
<div class="container section-gap" id="pageRoot" data-api="{% url 'stream:sermons_list_json' %}">
  <div class="page-hero library-hero mb-4">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
      <div>
        <span class="eyebrow"><i class="bi bi-journal-music"></i> Stream library</span>
        <h1 class="mb-2">Past Streams</h1>
        <p class="lede mb-3">Browse sermons, testimonies, and worship sets. Queue messages without leaving the page and keep listening as you move around the site.</p>
        <div class="hero-actions">
          <button class="btn btn-brand" type="button" data-bs-toggle="offcanvas" data-bs-target="#liveDrawer"><i class="bi bi-broadcast-pin"></i> Listen live</button>
          <a class="btn btn-outline-light" href="#filters"><i class="bi bi-funnel"></i> Jump to filters</a>
          {% if request.user.is_staff %}
            <a class="btn btn-soft" href="{% url 'stream:upload_sermon' %}"><i class="bi bi-upload"></i> Upload</a>
          {% endif %}
        </div>
      </div>
      <div class="d-flex flex-column gap-2 align-items-start">
        <span class="stat-pill"><i class="bi bi-collection-play"></i> {{ page_obj.paginator.count }} items</span>
        {% if q %}
          <span class="stat-pill"><i class="bi bi-search"></i> Filtered: {{ q }}</span>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="filters-card p-3 p-md-4" id="filters">
    <form id="filtersForm" class="filter-rail" method="get">
      <div class="pill-input">
        <i class="bi bi-search"></i>
        <input type="search" name="q" value="{{ q }}" placeholder="Search title, speaker, or tag">
      </div>
      <div class="pill-input">
        <i class="bi bi-calendar-event"></i>
        <select name="year" aria-label="Filter by year">
          <option value="">Any year</option>
          {% for y in years %}
            <option value="{{ y }}" {% if active_year|stringformat:"s" == y|stringformat:"s" %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="pill-input">
        <i class="bi bi-person"></i>
        <select name="speaker" aria-label="Filter by speaker">
          <option value="">Any speaker</option>
          {% for sp in top_speakers %}
            <option value="{{ sp.speaker }}" {% if active_speaker == sp.speaker %}selected{% endif %}>{{ sp.speaker }}</option>
          {% endfor %}
        </select>
      </div>
      <input type="hidden" name="tag" id="tagInput" value="{{ active_tag }}">
      <div class="d-flex gap-2 align-items-stretch">
        <button class="btn btn-primary" type="submit"><i class="bi bi-play"></i> Apply</button>
        <button class="btn btn-outline-light" type="button" id="filtersClear"><i class="bi bi-x-lg"></i></button>
      </div>
    </form>
    <div class="active-filters mt-3">
      {% if q %}<button class="chip" type="button" data-clear="q"><i class="bi bi-search"></i> {{ q }} <i class="bi bi-x-lg"></i></button>{% endif %}
      {% if active_tag %}<button class="chip" type="button" data-clear="tag"><i class="bi bi-tag"></i> #{{ active_tag }} <i class="bi bi-x-lg"></i></button>{% endif %}
      {% if active_year %}<button class="chip" type="button" data-clear="year"><i class="bi bi-calendar-event"></i> {{ active_year }} <i class="bi bi-x-lg"></i></button>{% endif %}
      {% if active_speaker %}<button class="chip" type="button" data-clear="speaker"><i class="bi bi-person"></i> {{ active_speaker }} <i class="bi bi-x-lg"></i></button>{% endif %}
      {% if q or active_tag or active_year or active_speaker %}
        <button class="chip danger" type="button" id="clearAll"><i class="bi bi-trash3"></i> Clear all</button>
      {% endif %}
    </div>
  </div>

  <div class="row g-4 section-gap">
    <div class="col-12 col-xl-8">
      <div class="row g-3" id="sermonGrid">
        {% for s in object_list %}
          <div class="col-12 col-sm-6">
            <div class="lot-card h-100 position-relative" data-slug="{{ s.slug }}">
              <div class="lot-thumb">
                {% if s.cover %}
                  <img src="{{ s.cover.url }}" alt="{{ s.title }}" loading="lazy" decoding="async">
                {% endif %}
                <div class="lot-actions">
                  <button class="btn btn-primary btn-sm js-play-now" data-slug="{{ s.slug }}" title="Play now"><i class="bi bi-play-fill"></i></button>
                  <button class="btn btn-outline-light btn-sm js-add-queue" data-slug="{{ s.slug }}" title="Add to queue"><i class="bi bi-plus-lg"></i></button>
                </div>
                <div class="lot-overlay">
                  <span class="lot-chip"><i class="bi bi-clock-history"></i> {% if s.duration_s %}{{ s.duration_hm }}{% else %}—{% endif %}</span>
                  <button type="button" class="btn btn-outline-light btn-sm js-open-details" data-slug="{{ s.slug }}"><i class="bi bi-box-arrow-up-right"></i> Details</button>
                </div>
              </div>
              <div class="p-3 d-flex flex-column gap-2 h-100">
                <div>
                  <div class="fw-bold text-truncate" title="{{ s.title }}">{{ s.title }}</div>
                  <div class="meta-line">{{ s.speaker }} · {{ s.date|date:"M j, Y" }}</div>
                </div>
                {% if s.tags_list %}
                  <div class="d-flex flex-wrap gap-1">
                    {% for t in s.tags_list %}
                      <span class="tag-pill">#{{ t }}</span>
                    {% endfor %}
                  </div>
                {% endif %}
                <div class="d-flex flex-wrap gap-2 mt-auto">
                  <button class="btn btn-primary btn-sm js-play-now" data-slug="{{ s.slug }}"><i class="bi bi-play-fill"></i> Play</button>
                  <button class="btn btn-outline-light btn-sm js-add-queue" data-slug="{{ s.slug }}"><i class="bi bi-plus-lg"></i> Queue</button>
                  <button type="button" class="btn btn-outline-light btn-sm js-open-details" data-slug="{{ s.slug }}">Details</button>
                </div>
              </div>
            </div>
          </div>
        {% empty %}
          <div class="col">
            <div class="alert alert-secondary">No sermons yet.</div>
          </div>
        {% endfor %}
      </div>

      {% if is_paginated %}
      <nav class="mt-3" aria-label="Pagination" id="paginationBar">
        <ul class="pagination">
          {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link js-page" href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q|urlencode }}{% endif %}" data-page="{{ page_obj.previous_page_number }}">Prev</a></li>
          {% endif %}
          <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>
          {% if page_obj.has_next %}
            <li class="page-item"><a class="page-link js-page" href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q|urlencode }}{% endif %}" data-page="{{ page_obj.next_page_number }}">Next</a></li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}
    </div>

    <aside class="col-12 col-xl-4">
      <div class="glass-card p-3 p-md-4 mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="m-0 d-flex align-items-center gap-2"><i class="bi bi-stars"></i> Quick picks</h6>
          <button class="btn btn-outline-light btn-sm" id="quickShuffle"><i class="bi bi-shuffle"></i></button>
        </div>
        <ul class="quick-list" id="quickList">
          <li class="text-muted small">Loading picks…</li>
        </ul>
      </div>

      <div class="glass-card p-3 p-md-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="m-0 d-flex align-items-center gap-2"><i class="bi bi-tags"></i> Popular tags</h6>
          <small class="text-muted">tap to filter</small>
        </div>
        <div class="d-flex flex-wrap gap-2" id="tagCloud">
          {% if top_tags %}
            {% for tag,count in top_tags %}
              <button class="chip js-filter-tag" type="button" data-tag="{{ tag }}">#{{ tag }}</button>
            {% endfor %}
          {% else %}
            <span class="text-muted small">No tags yet.</span>
          {% endif %}
        </div>
      </div>
    </aside>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const form = document.getElementById('filtersForm');
  const tagInput = document.getElementById('tagInput');
  const clearBtn = document.getElementById('filtersClear');
  const clearAll = document.getElementById('clearAll');
  const tagCloud = document.getElementById('tagCloud');
  const quickList = document.getElementById('quickList');
  const quickShuffle = document.getElementById('quickShuffle');
  const summaryApi = "{% url 'stream:sidebar_summary_json' %}";

  const getParams = () => {
    const fd = new FormData(form);
    return Object.fromEntries(fd.entries());
  };

  async function apply(params = {}, resetPage = true){
    if(!form) return;
    const next = { ...getParams(), ...params };
    if(resetPage) next.page = 1;

    if(window.spaLoad){
      await window.spaLoad(next);
    }else{
      Object.entries(next).forEach(([k,v])=>{
        const input = form.querySelector(`[name="${k}"]`);
        if(input) input.value = v;
      });
      form.submit();
    }
  }

  form?.addEventListener('submit', (e)=>{ e.preventDefault(); apply(); });
  clearBtn?.addEventListener('click', ()=> apply({ q:'', year:'', speaker:'', tag:'' }));
  clearAll?.addEventListener('click', ()=> apply({ q:'', year:'', speaker:'', tag:'' }));

  document.addEventListener('click', (e)=>{
    const tagBtn = e.target.closest('.js-filter-tag');
    if(tagBtn){
      e.preventDefault();
      if(tagInput) tagInput.value = tagBtn.dataset.tag || '';
      apply({ tag: tagInput?.value || '' });
      return;
    }
    const clearChip = e.target.closest('[data-clear]');
    if(clearChip){
      e.preventDefault();
      const field = clearChip.dataset.clear;
      const input = form?.querySelector(`[name="${field}"]`);
      if(input) input.value = '';
      apply({ [field]: '' });
    }
  });

  async function loadSummary(){
    if(!summaryApi) return;
    try{
      const res = await fetch(summaryApi, { credentials:'same-origin' });
      const data = await res.json();

      if(tagCloud && data.top_tags){
        tagCloud.innerHTML = data.top_tags.slice(0,12).map(t =>
          `<button class="chip js-filter-tag" type="button" data-tag="${t.name}">#${t.name}</button>`
        ).join("") || `<span class="text-muted small">No tags yet.</span>`;
      }

      if(quickList && data.random_items){
        quickList.innerHTML = data.random_items.map(it => `
          <li class="quick-item">
            <img src="${it.cover || ''}" alt="">
            <div class="flex-grow-1">
              <div class="fw-semibold text-truncate">${it.title}</div>
              <div class="text-muted small">${it.speaker || ''} ${it.duration_hm ? '· '+it.duration_hm : ''}</div>
            </div>
            <div class="d-flex gap-1">
              <button class="btn btn-primary btn-sm js-play-now" data-slug="${it.slug}" title="Play"><i class="bi bi-play-fill"></i></button>
              <button class="btn btn-outline-light btn-sm js-add-queue" data-slug="${it.slug}" title="Queue"><i class="bi bi-plus-lg"></i></button>
            </div>
          </li>
        `).join("") || `<li class="text-muted small">No picks yet.</li>`;
      }
    }catch(err){
      if(quickList){ quickList.innerHTML = `<li class="text-muted small">Could not load picks.</li>`; }
    }
  }
  quickShuffle?.addEventListener('click', (e)=>{ e.preventDefault(); loadSummary(); });
  loadSummary();

  // Quick queued feedback
  document.addEventListener('click', (e)=>{
    const addBtn = e.target.closest('.js-add-queue');
    if(!addBtn) return;
    const card = addBtn.closest('[data-slug]');
    if(!card) return;
    const burst = document.createElement('div');
    burst.className = 'queued-burst';
    burst.textContent = 'Queued';
    card.appendChild(burst);
    setTimeout(()=> burst.remove(), 1100);
  });
})();

// Details modal (glass)
document.addEventListener('click', async (e)=>{
  const btn = e.target.closest('.js-open-details');
  if(!btn) return;
  e.preventDefault();

  const slug = btn.dataset.slug || btn.getAttribute('data-slug');
  if(!slug) return;

  const modalEl = document.getElementById('sermonModal');
  const content = modalEl.querySelector('.modal-content');

  modalEl.classList.add('is-loading');
  bootstrap.Modal.getOrCreateInstance(modalEl).show();

  content.style.setProperty('--md-cover', 'none');
  document.getElementById('md-title').textContent = '';
  document.getElementById('md-meta').textContent = '';
  document.getElementById('md-tags').innerHTML = '';
  document.getElementById('md-desc').textContent = '';

  try{
    const res = await fetch(`/api/sermons/${encodeURIComponent(slug)}.json`, {credentials:'same-origin'});
    if(!res.ok) throw new Error('Failed');
    const s = await res.json();

    if(s.cover){
      content.style.setProperty('--md-cover', `url("${s.cover}")`);
      const img = document.getElementById('md-cover');
      if(img) img.src = s.cover;
    }
    document.getElementById('md-title').textContent = s.title || '';
    document.getElementById('md-meta').textContent  = `${s.speaker || ''} · ${s.date_display || ''} · ${s.duration_hm || ''}`;
    document.getElementById('md-tags').innerHTML    = (s.tags||[]).map(t=>`<span class="badge rounded-pill me-1 mb-1">#${t}</span>`).join('');
    document.getElementById('md-desc').textContent  = s.description || '';

    const play  = document.getElementById('md-play');
    const queue = document.getElementById('md-queue');
    const open  = document.getElementById('md-open');
    const dl    = document.getElementById('md-download');
    const copy  = document.getElementById('md-copy');

    play.dataset.slug  = slug;
    queue.dataset.slug = slug;
    open.href = s.absolute_url || '#';
    dl.href   = s.audio || '#';

    copy.onclick = async () => {
      try{
        await navigator.clipboard.writeText(s.absolute_url || location.href);
        copy.innerHTML = '<i class="bi bi-check2"></i> Copied';
        setTimeout(()=> copy.innerHTML = '<i class="bi bi-link-45deg"></i> Copy link', 1200);
      }catch{}
    };

  }catch(err){
    console.error(err);
    alert('Could not load details.');
  }finally{
    modalEl.classList.remove('is-loading');
  }
});
</script>
{% endblock %}
