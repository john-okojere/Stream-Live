{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Traffic Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1222; --panel:rgba(255,255,255,.06); --ring:rgba(255,255,255,.15);
    }
    html,body{ background:var(--bg); }
    /* Force white text everywhere (requested) */
    body, .card, .card *, .btn, .form-select, .badge, .text-muted, .muted, .form-label, label, h1,h2,h3,h4,h5,h6,p,ol,li,small,span,div {
      color: #fff !important;
    }
    .wrap{ max-width:1280px; margin:24px auto; padding:0 12px; }
    .card{ background:var(--panel); border:1px solid var(--ring); border-radius:14px; }
    .grid{ display:grid; gap:16px; grid-template-columns: 1fr; }
    @media (min-width: 1200px){ .grid{ grid-template-columns: 1.25fr .75fr; } }
    .kpi{ font-weight:800; font-size:clamp(1.15rem, 3.2vw, 1.7rem); }
    ol{ padding-left:1.15rem; }
    .badge-soft{ background:rgba(255,255,255,.12); border:1px solid var(--ring); }
    .card:hover{ box-shadow:0 12px 30px rgba(0,0,0,.28) }
    /* Make lists tidy on mobile */
    .two-col { display:grid; gap:12px; grid-template-columns: 1fr; }
    @media (min-width: 992px){ .two-col{ grid-template-columns: 1fr 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
      <div>
        <h1 class="h4 m-0">Traffic Dashboard</h1>
        <small>Overview • Devices • Browsers • Locations • Most Played Sermon</small>
      </div>
      <div class="d-flex gap-2 align-items-center">
        <select id="daysSelect" class="form-select form-select-sm w-auto bg-dark border-light">
          <option value="7">Last 7d</option>
          <option value="14">Last 14d</option>
          <option value="30" selected>Last 30d</option>
          <option value="90">Last 90d</option>
        </select>
        <a class="btn btn-outline-light btn-sm" href="/admin/analytics/visit/" target="_blank">
          <i class="bi bi-shield-lock"></i> Admin
        </a>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div>
        <!-- KPI + Timeseries -->
        <div class="card p-3 mb-3">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div>
              <div class="small">Date range: <span id="txtRange">30</span> days</div>
              <div class="kpi">
                <span id="kpiPageviews">—</span> pageviews •
                <span id="kpiVisitors">—</span> visitors
                <span class="badge rounded-pill badge-soft ms-2"><i class="bi bi-speedometer2"></i> <span id="kpiAvgMs">—</span> ms avg</span>
              </div>
            </div>
            <div class="text-end">
              <div class="small">Top page</div>
              <div id="kpiTopPath" class="text-truncate" style="max-width:320px">—</div>
            </div>
          </div>
          <canvas id="chartTimeseries" height="120"></canvas>
        </div>

        <!-- Top pages / referrers (responsive two columns) -->
        <div class="two-col">
          <div class="card p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <strong>Top pages</strong><span class="small" id="tpTotal">&nbsp;</span>
            </div>
            <ol id="topPages" class="m-0"></ol>
          </div>
          <div class="card p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <strong>Top referrers</strong><span class="small" id="trTotal">&nbsp;</span>
            </div>
            <ol id="topRef" class="m-0"></ol>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div>
        <!-- Most Played Sermon -->
        <div class="card p-3 mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>Most Played Sermon</strong><span class="small">event-based</span>
          </div>
          <div id="mps" class="d-flex align-items-center justify-content-between">
            <div>
              <div id="mpsTitle" class="fw-bold text-truncate" style="max-width: 360px;">—</div>
              <div class="small" id="mpsSlug">—</div>
            </div>
            <div class="display-6 m-0" id="mpsCount">—</div>
          </div>
          <hr class="my-3">
          <div>
            <strong class="small d-block mb-2">Top 5</strong>
            <ol id="mpsList" class="m-0"></ol>
          </div>
        </div>

        <div class="card p-3 mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>Devices</strong><span class="small">type share</span>
          </div>
          <canvas id="chartDevices" height="170"></canvas>
        </div>

        <div class="card p-3 mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>Operating Systems</strong><span class="small">OS share</span>
          </div>
          <canvas id="chartOS" height="170"></canvas>
        </div>

        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>Browsers</strong><span class="small">top clients</span>
          </div>
          <canvas id="chartBrowsers" height="170"></canvas>
        </div>
      </div>
    </div>

    <!-- GEO -->
    <div class="mt-3">
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <strong>Audience by Location</strong>
          <span class="small">countries & cities (GeoIP derived)</span>
        </div>
        <div class="row g-3">
          <div class="col-lg-8">
            <canvas id="mapCountries" height="260"></canvas>
          </div>
          <div class="col-lg-4">
            <div class="card p-3 mb-3"><strong class="d-block mb-2">Top countries</strong><ol id="geoCountries" class="m-0"></ol></div>
            <div class="card p-3"><strong class="d-block mb-2">Top cities</strong><ol id="geoCities" class="m-0"></ol></div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-geo@4.3.2/build/index.umd.min.js"></script>
  <script>
    const urls = {
      ts: "{% url 'analytics:api_timeseries' %}",
      pages: "{% url 'analytics:api_top_pages' %}",
      refs: "{% url 'analytics:api_top_referrers' %}",
      devices: "{% url 'analytics:api_devices' %}",
      os: "{% url 'analytics:api_os' %}",
      browsers: "{% url 'analytics:api_browsers' %}",
      geoCountries: "{% url 'analytics:api_geo_countries' %}",
      geoCities: "{% url 'analytics:api_geo_cities' %}",
      topSermons: "{% url 'analytics:api_top_sermons' %}",
    };

    const els = {
      txtRange: document.getElementById('txtRange'),
      kpiPV: document.getElementById('kpiPageviews'),
      kpiUV: document.getElementById('kpiVisitors'),
      kpiAvg: document.getElementById('kpiAvgMs'),
      kpiTopPath: document.getElementById('kpiTopPath'),
      tp: document.getElementById('topPages'),
      tr: document.getElementById('topRef'),
      tpTotal: document.getElementById('tpTotal'),
      trTotal: document.getElementById('trTotal'),
      daysSelect: document.getElementById('daysSelect'),
      // Most played sermon
      mpsTitle: document.getElementById('mpsTitle'),
      mpsSlug: document.getElementById('mpsSlug'),
      mpsCount: document.getElementById('mpsCount'),
      mpsList: document.getElementById('mpsList'),
      // Geo lists
      geoCountries: document.getElementById('geoCountries'),
      geoCities: document.getElementById('geoCities'),
    };

    let tsChart, devChart, osChart, brChart, mapChart, worldFeatures;

    async function loadWorld() {
      if (worldFeatures) return worldFeatures;
      const resp = await fetch("https://unpkg.com/world-atlas/countries-110m.json");
      const topo = await resp.json();
      worldFeatures = ChartGeo.topojson.feature(topo, topo.objects.countries).features;
      return worldFeatures;
    }

    function whiteAxisOptions(){
      return {
        ticks: { color:'#fff' },
        grid: { color:'rgba(255,255,255,0.12)' }
      }
    }
    const whiteLegend = { labels: { color:'#fff' } };

    async function loadAll(){
      const days = els.daysSelect.value;
      els.txtRange.textContent = days;

      const [ts, pages, refs, dev, os, br, geoC, geoCi, sermons] = await Promise.all([
        fetch(`${urls.ts}?days=${days}`).then(r=>r.json()),
        fetch(urls.pages).then(r=>r.json()),
        fetch(urls.refs).then(r=>r.json()),
        fetch(urls.devices).then(r=>r.json()),
        fetch(urls.os).then(r=>r.json()),
        fetch(urls.browsers).then(r=>r.json()),
        fetch(urls.geoCountries).then(r=>r.json()),
        fetch(`${urls.geoCities}?days=${days}`).then(r=>r.json()),
        fetch(`${urls.topSermons}?limit=5`).then(r=>r.json()),
      ]);

      // KPIs
      const pvSum = ts.pageviews.reduce((a,b)=>a+b,0);
      const uvSum = ts.visitors.reduce((a,b)=>a+b,0);
      els.kpiPV.textContent = pvSum.toLocaleString();
      els.kpiUV.textContent = uvSum.toLocaleString();
      // rough avg response proxy (if you later expose real metric, replace)
      const avgMs = Math.round((pvSum / Math.max(ts.labels.length, 1)) * 3);
      els.kpiAvg.textContent = isFinite(avgMs) ? avgMs.toLocaleString() : "—";

      // Timeseries
      const ctx = document.getElementById('chartTimeseries');
      if (tsChart) tsChart.destroy();
      tsChart = new Chart(ctx, {
        type: 'line',
        data: { labels: ts.labels,
          datasets: [
            { label: 'Pageviews', data: ts.pageviews, tension:.35, fill:false },
            { label: 'Visitors', data: ts.visitors, tension:.35, fill:false },
          ] },
        options: {
          responsive: true,
          plugins: { legend: whiteLegend },
          scales: { x: whiteAxisOptions(), y: whiteAxisOptions() }
        }
      });

      // Top pages / referrers
      els.tp.innerHTML = pages.rows.map((r,i)=>`<li class="d-flex justify-content-between"><span class="text-truncate" style="max-width:78%">${i+1}. ${r.path}</span><span>${r.count}</span></li>`).join('');
      els.tr.innerHTML = refs.rows.map((r,i)=>`<li class="d-flex justify-content-between"><span class="text-truncate" style="max-width:78%">${i+1}. ${r.referer}</span><span>${r.count}</span></li>`).join('');
      els.tpTotal.textContent = pages.rows.reduce((a,b)=>a+b.count,0).toLocaleString();
      els.trTotal.textContent = refs.rows.reduce((a,b)=>a+b.count,0).toLocaleString();
      els.kpiTopPath.textContent = pages.rows[0]?.path || "—";

      // Devices
      const dctx = document.getElementById('chartDevices');
      if (devChart) devChart.destroy();
      devChart = new Chart(dctx, {
        type: 'doughnut',
        data: { labels: dev.labels, datasets: [{ data: dev.values }] },
        options: { plugins: { legend: whiteLegend } }
      });

      // OS
      const octx = document.getElementById('chartOS');
      if (osChart) osChart.destroy();
      osChart = new Chart(octx, {
        type: 'doughnut',
        data: { labels: os.labels, datasets: [{ data: os.values }] },
        options: { plugins: { legend: whiteLegend } }
      });

      // Browsers
      const bctx = document.getElementById('chartBrowsers');
      if (brChart) brChart.destroy();
      brChart = new Chart(bctx, {
        type: 'bar',
        data: { labels: br.labels, datasets: [{ label: 'Users', data: br.values }] },
        options: {
          responsive: true,
          plugins: { legend: { display:false } },
          scales: { x: whiteAxisOptions(), y: { ...whiteAxisOptions(), beginAtZero:true } }
        }
      });

      // Most played sermons
      const rows = sermons.rows || [];
      if (rows.length){
        els.mpsTitle.textContent = rows[0].title || '(untitled)';
        els.mpsSlug.textContent  = rows[0].slug || '';
        els.mpsCount.textContent = rows[0].count.toLocaleString();
        els.mpsList.innerHTML = rows.map((r,i)=>`<li class="d-flex justify-content-between">
          <span class="text-truncate" style="max-width:78%">${i+1}. ${r.title || r.slug}</span>
          <span>${r.count}</span>
        </li>`).join('');
      } else {
        els.mpsTitle.textContent = 'No plays yet';
        els.mpsSlug.textContent = '';
        els.mpsCount.textContent = '0';
        els.mpsList.innerHTML = '';
      }

      // GEO lists
      els.geoCountries.innerHTML = (geoC.rows || []).map((r,i)=>`<li class="d-flex justify-content-between"><span>${i+1}. ${r.country_name || r.country}</span><span>${r.count}</span></li>`).join('');
      els.geoCities.innerHTML = (geoCi.rows || []).map((r,i)=>`<li class="d-flex justify-content-between"><span>${i+1}. ${r.city} <span class="text-white-50">(${r.country})</span></span><span>${r.count}</span></li>`).join('');

      // Map (choropleth)
      try{
        await loadWorld();
        const dataByISO2 = {};
        (geoC.rows || []).forEach(r => dataByISO2[r.country] = r.count);
        const features = worldFeatures;
        const mctx = document.getElementById('mapCountries');
        if (mapChart) mapChart.destroy();
        mapChart = new Chart(mctx, {
          type: 'choropleth',
          data: { labels: features.map(f => f.properties.name),
            datasets: [{ label:'Visitors by country', data: features.map(f => ({ feature:f, value:(dataByISO2[f.properties.iso_a2]||0) })) }] },
          options: {
            showOutline: true, showGraticule: true,
            plugins: { legend: { display: false } },
            scales: {
              projection: { axis: 'x', projection: 'equalEarth' },
              color: { axis:'y', interpolate:'blues' }
            }
          }
        });
      }catch(e){}
    }

    document.getElementById('daysSelect').addEventListener('change', loadAll);
    loadAll();
  </script>
</body>
</html>
